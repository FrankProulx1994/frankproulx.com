<!DOCTYPE html>
<html lang="fr">
<head>
  <script>
  if ('serviceWorker' in navigator) {
    try { navigator.serviceWorker.register('/sw.js'); } catch(e) {}
  }
  </script>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#0b0b0b">
  <title data-i18n="title">Calculatrice de R√©ponse Impulsive</title>

  <!-- Chart libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>

  <style>
    /* ===== Palette ===== */
    :root{
      --bg0:#0b0b0b; /* fond principal */
      --bg1:#131313; /* cartes */
      --bg2:#1b1b1b; /* √©l√©ments secondaires */
      --fg0:#ffffff; /* texte primaire */
      --fg1:#e8e8e8; /* texte secondaire */
      --muted:#a9a9a9; /* texte doux */
      --red:#ff3434;
      --red2:#e61919;
      --green:#23d14d;
      --green2:#18b33f;
      --blue:#4aa3ff;
      --border:#292929;
      --shadow: 0 10px 28px rgba(0,0,0,.55);
    }

    /* ===== Base ===== */
    html,body{height:100%}
    body{
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin:0; padding:0;
      background: var(--bg0);
      color: var(--fg1);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* background visual WITHOUT blocking clicks */
    body::before, body::after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none; /* important: never block clicks */
      z-index:-1;
    }
    body::before{
      background:
        radial-gradient(900px 600px at 90% -10%, rgba(255,52,52,.24), transparent 60%),
        radial-gradient(900px 600px at -10% 110%, rgba(255,0,0,.18), transparent 60%),
        linear-gradient(135deg, #080808 0%, #0f0f0f 40%, #121212 60%, #0c0c0c 100%);
      animation: bgDrift 16s ease-in-out infinite alternate;
      filter: saturate(1.05);
    }
    body::after{
      background-image: linear-gradient(135deg, rgba(255,255,255,.04) 0 1px, transparent 1px 20px);
      background-size: 20px 20px;
      opacity:.35;
      animation: scan 3.5s linear infinite;
      mix-blend-mode: overlay;
    }
    @keyframes bgDrift{
      0%{ transform: translate3d(0,0,0); }
      100%{ transform: translate3d(0,-12px,0); }
    }
    @keyframes scan{
      0%{ background-position: 0 0; }
      100%{ background-position: 40px 40px; }
    }

    /* ===== Top language bar ===== */
    .langbar{
      position:sticky; top:0; z-index:5;
      background: rgba(15,15,15,.9);
      backdrop-filter: blur(6px);
      color: var(--fg1);
      padding: 8px 12px;
      display:flex; gap:8px; justify-content:flex-end; align-items:center;
      border-bottom: 2px solid var(--red);
      box-shadow: var(--shadow);
    }
    .langbar button{
      margin:0 4px; padding:6px 10px;
      border-radius:6px; border:1px solid var(--red);
      background:#1c1c1c; color:#fff; cursor:pointer;
      transition: transform .15s, box-shadow .15s, background .15s, border-color .15s;
    }
    .langbar button:hover{ transform: translateY(-1px); box-shadow: 0 0 10px rgba(255,52,52,.3); }
    .langbar button.active{ background: var(--red); border-color: var(--red2); }

    /* ===== Header ===== */
    header{
      background: linear-gradient(135deg, #121212, #171717);
      color: var(--red);
      padding: 20px 10px;
      text-align:center;
      border-bottom: 3px solid var(--red);
      box-shadow: var(--shadow);
      text-transform: uppercase;
      letter-spacing:.4px;
    }
    header h1{ margin:0; font-size:28px; color:var(--red); }
    header h2{ margin:10px 0 0; font-size:18px; font-style:italic; color:#cfcfcf; }
    header h3{ margin:5px 0 0; font-size:16px; color:#ff5a5a; }

    /* ===== Cards / Containers ===== */
    .container{
      max-width: 860px;
      margin: 20px auto;
      padding: 20px;
      background: var(--bg1);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
    }

    /* ===== Buttons ===== */
    .button{
      padding: 12px 22px;
      font-size: 16px;
      cursor:pointer;
      border:none;
      margin:10px;
      border-radius:10px;
      font-weight:800;
      letter-spacing:.25px;
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .button:active{ transform: translateY(1px) scale(.99); }

    .yes-button{
      background: var(--green);
      color:#071407;
      text-shadow: 0 1px 0 rgba(255,255,255,.2);
      box-shadow: 0 8px 18px rgba(35,209,77,.25);
    }
    .yes-button:hover{ background: var(--green2); }

    .no-button{
      background: var(--red);
      color:#fff;
      box-shadow: 0 8px 18px rgba(255,52,52,.25);
    }
    .no-button:hover{ background: var(--red2); }

    .hidden{ display:none }

    .positive-question{ color: var(--green); font-weight: 900; text-shadow: 0 0 10px rgba(35,209,77,.25); }
    .negative-question{ color: var(--red); font-weight: 900; text-shadow: 0 0 10px rgba(255,52,52,.25); }

    .result-header{
      font-weight:900;
      font-size:20px;
      margin-top:20px;
      color: var(--blue);
      border-bottom: 2px solid var(--blue);
      padding-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .4px;
    }

    .empty-space{ margin:20px 0 }
    .result-content p{ margin:8px 0; font-size:16px; color:#e6e6e6 }
    .result-content .emphasis{ color: var(--red); font-weight: 900 }
    .button-container{ text-align:center; margin-top:20px }

    ul{ list-style:none; padding:0 }
    ul li{ margin:5px 0; color:#cfcfcf }
    .precision{ font-style:italic; color: var(--muted) }

    /* Welcome card */
    #welcome-screen{
      background: rgba(22,22,22,.92);
      color: var(--fg1);
      border: 1px solid var(--border);
      width: min(920px, 92vw);
      margin: 60px auto;
      border-radius: 12px;
      box-shadow: var(--shadow);
    }
    input[type="text"]{
      background:#0f0f0f;
      color:#fff;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      outline:none;
      transition: border .15s, box-shadow .15s;
    }
    input[type="text"]:focus{
      border-color: var(--red);
      box-shadow: 0 0 0 3px rgba(255,52,52,.15);
    }

    /* Charts */
    canvas{ background:#0e0e0e; border-radius:10px }

    /* APK link style */
    .apk-link{
      text-decoration:none;
      display:inline-block;
      background: #202020;
      color:#fff;
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 10px 16px;
      transition: transform .15s, box-shadow .15s, background .15s, border-color .15s;
    }
    .apk-link:hover{
      background:#262626; border-color:#333; transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(255,255,255,.06);
    }

    @media screen and (max-width:600px){
      body{ font-size:16px; padding:10px }
      .container{ padding:12px; margin:12px; box-shadow:none; border-radius: 10px }
      input[type="text"]{ width:100% !important; font-size:16px }
      .button{ width:90%; margin:10px auto; font-size:16px }
      canvas{ max-width:100% !important; height:auto !important }
      #welcome-screen{ margin:30px auto; padding: 10px }
    }
  </style>
</head>
<body>
  <div class="langbar">
    <span>Lang / Langue:</span>
    <button id="btn-fr" class="active" type="button" onclick="setLang('fr')">FR</button>
    <button id="btn-en" type="button" onclick="setLang('en')">EN</button>
  </div>

  <!-- Page de bienvenue / Welcome screen -->
  <div id="welcome-screen" style="text-align:center; padding:100px;">
    <h1 data-i18n="welcomeTitle">Bienvenue sur la Calculatrice de R√©ponse Impulsive</h1>
    <p data-i18n="welcomeIntro">
      La calculatrice de r√©ponse impulsive vous aide √† r√©fl√©chir avant d'agir √† l'aide du mod√®le M.A.R.S. : Moi ‚Äì Autres ‚Äì Relation ‚Äì Situation.
    </p>
    <p data-i18n="welcomePrompt">Indique l'action, la d√©cision ou le choix que tu veux explorer :</p>
    <input id="userDecision" type="text" data-i18n-placeholder="decisionPlaceholder" placeholder="Exemple : Frapper Jeff" style="padding:10px; width:80%; max-width:400px; font-size:16px; margin-bottom:20px;"/>
    <p data-i18n="welcomeClick">Clique sur le bouton ci-dessous pour commencer.</p>
    <button class="button yes-button" data-i18n="start" onclick="launchCalculator()">Commencer</button>
    <!-- Bouton de t√©l√©chargement de l'application Android -->
    <div style="margin-top:20px;">
      <a href="app-release-signed.apk" download class="apk-link">üì± T√©l√©charger l'application Android (.apk)</a>
    </div>
  </div>

  <!-- Page principale masqu√©e / Main content -->
  <div class="hidden" id="main-content">
    <header>
      <h1 data-i18n="title">Calculatrice de R√©ponse Impulsive</h1>
      <h2>&nbsp;</h2>
      <h3 data-i18n="basedOn">Bas√©e sur le mod√®le</h3>
      <h3><strong>M.A.R.S</strong></h3>
    </header>
    <div class="container">
      <div id="questions"></div>
      <div id="definition-box" style="background:#13131a;padding:15px;margin-top:20px;border-radius:10px;display:none;font-size:.95em;border:1px solid var(--border);"></div>
      <div class="hidden" id="results">
        <div class="result-content" id="result-content"></div>
      </div>
      <div class="button-container">
        <button class="button yes-button" data-i18n="restart" onclick="restart()">Recommencer</button>
        <button class="button no-button"  data-i18n="print" onclick="window.print()">Imprimer</button>
      </div>
    </div>
  </div>

<script>
// ===== i18n dictionnaire =====
var I18N = {
  fr: {
    title:'Calculatrice de R√©ponse Impulsive',
    welcomeTitle:'Bienvenue sur la Calculatrice de R√©ponse Impulsive',
    welcomeIntro:"La calculatrice de r√©ponse impulsive vous aide √† r√©fl√©chir avant d'agir √† l'aide du mod√®le M.A.R.S. : Moi ‚Äì Autres ‚Äì Relation ‚Äì Situation.",
    welcomePrompt:"Indique l'action, la d√©cision ou le choix que tu veux explorer :",
    decisionPlaceholder:'Exemple : Frapper Jeff',
    welcomeClick:'Clique sur le bouton ci-dessous pour commencer.',
    start:'Commencer',
    basedOn:'Bas√©e sur le mod√®le',
    restart:'Recommencer',
    print:'Imprimer',
    dacTitle:'Choix / D√©cision / Action',
    ifDo:"Si tu choisis d'entreprendre cette action, d√©cision ou ce choix,",
    ifDont:"Si tu choisis de ne pas entreprendre cette action, d√©cision ou ce choix,",
    isImpactOn: function(el, kind){ return "L'impact sur <span class='emphasis'>"+el+"</span> est-il " + (kind==='Positive'?'positif':'n√©gatif') + " ?"; },
    yes:'Oui', no:'Non',
    orderIs: function(kind,order){ return "Ordre d√©termin√© ("+(kind==='Positive'?'Positif':'N√©gatif')+") : <span class='emphasis'>"+order.join(', ')+"</span>"; },
    orderCorrect:"L'ordre indiqu√© est-il correct ?",
    overallResult:'R√©sultat global :',
    overallResultDesc:'Note finale repr√©sentant √† quel point tu crois que cette d√©cision est bonne.',
    globalScore:function(s){ return "Score global : "+s+" / 10 ("+(s*10)+"%)"; },
    posTable:'Tableau positif :',
    posDesc:"Facteurs qui font pencher la balance en faveur de faire cette action, ce choix ou cette d√©cision.",
    posScore:function(s,p){ return "Score positif sur : "+s+" / 10 soit "+p+"%"; },
    negTable:'Tableau n√©gatif :',
    negDesc:"Facteurs qui font pencher la balance en faveur de ne pas faire cette action, ce choix ou cette d√©cision.",
    negScore:function(s,p){ return "Score n√©gatif sur : "+s+" / 10 soit "+p+"%"; },
    details:'Pr√©cision :',
    none:'Aucune pr√©cision',
    caution:'√Ä faire attention',
    rejTitle:'‚ö†Ô∏è Nombre de validations rejet√©es :',
    rejDesc:"Indique un niveau de confusion ou d‚Äôambivalence dans tes r√©ponses. S'il est sup√©rieur √† 0, attends avant de d√©cider et refais le test plus tard.",
    posChart:'Graphique des impacts positifs :',
    posChartDesc:'Montre ce qui affaiblit la balance si tu choisis de faire. Bas√© sur les √©l√©ments jug√©s n√©gatifs ("NON").',
    negChart:'Graphique des impacts n√©gatifs :',
    negChartDesc:'Montre ce qui affaiblit la balance si tu choisis de ne pas faire. Bas√© sur les √©l√©ments jug√©s n√©gatifs ("NON").',
    elements:['Situation','Relation','Autres','Moi'],
    defs:{
      'Moi':"üí≠ <strong>Moi (M):</strong> √âtat int√©rieur : √©motions, pens√©es, besoins, d√©sirs, valeurs, craintes ‚Äî et leur influence sur tes r√©actions.",
      'Autres':"üë• <strong>Autres (A):</strong> Personnes impliqu√©es : √©motions, intentions, comportements, perceptions, et leur impact r√©ciproque.",
      'Relation':"üîó <strong>Relation (R):</strong> Dynamique Moi‚ÄìAutres : qualit√© de la communication, confiance, attentes, habitudes, et r√¥le des √©motions.",
      'Situation':"üåç <strong>Situation (S):</strong> Contexte : environnement, contraintes, √©v√©nements, stress et autres facteurs qui influencent comportements et √©motions."
    }
  },
  en: {
    title:'Impulsive Response Calculator',
    welcomeTitle:'Welcome to the Impulsive Response Calculator',
    welcomeIntro:'This calculator helps you pause before acting using the M.A.R.S. model: Self ‚Äì Others ‚Äì Relationship ‚Äì Situation.',
    welcomePrompt:'Describe the action, decision, or choice you want to explore:',
    decisionPlaceholder:'Example: Punch Jeff',
    welcomeClick:'Click the button below to begin.',
    start:'Start',
    basedOn:'Based on the model',
    restart:'Restart',
    print:'Print',
    dacTitle:'Decision / Action / Choice',
    ifDo:'If you choose to take this action/decision/choice,',
    ifDont:'If you choose NOT to take this action/decision/choice,',
    isImpactOn:function(el,kind){ return "Is the impact on <span class='emphasis'>"+el+"</span> " + (kind==='Positive'?'positive':'negative') + "?"; },
    yes:'Yes', no:'No',
    orderIs:function(kind,order){ return "Determined order ("+kind+"): <span class='emphasis'>"+order.join(', ')+"</span>"; },
    orderCorrect:'Is this order correct?',
    overallResult:'Overall Result:',
    overallResultDesc:'Final score representing how much you believe this decision is good.',
    globalScore:function(s){ return "Global score: "+s+" / 10 ("+(s*10)+"%)"; },
    posTable:'Positive table:',
    posDesc:'Factors pushing toward doing this action/choice/decision.',
    posScore:function(s,p){ return "Positive score: "+s+" / 10 i.e. "+p+"%"; },
    negTable:'Negative table:',
    negDesc:'Factors pushing toward NOT doing this action/choice/decision.',
    negScore:function(s,p){ return "Negative score: "+s+" / 10 i.e. "+p+"%"; },
    details:'Details:',
    none:'No details',
    caution:'Be careful',
    rejTitle:'‚ö†Ô∏è Rejected validations:',
    rejDesc:'Indicates confusion or ambivalence. If above 0, wait before deciding and try the test again later.',
    posChart:'Positive impacts chart:',
    posChartDesc:'Shows what weakens the balance if you choose to DO. Based on elements marked negative ("No").',
    negChart:'Negative impacts chart:',
    negChartDesc:'Shows what weakens the balance if you choose to NOT DO. Based on elements marked negative ("No").',
    elements:['Situation','Relationship','Others','Self'],
    defs:{
      'Self':"üí≠ <strong>Self (S):</strong> Inner state: emotions, thoughts, needs, desires, values, fears ‚Äî and how they shape reactions.",
      'Others':"üë• <strong>Others (O):</strong> People involved: emotions, intentions, behaviours, perceptions, and reciprocal impact.",
      'Relationship':"üîó <strong>Relationship (R):</strong> Self‚ÄìOthers dynamic: communication quality, trust, expectations, habits, and role of emotions.",
      'Situation':"üåç <strong>Situation (Si):</strong> Context: environment, constraints, events, stressors, and other influencing factors."
    }
  }
};

var LANG = 'fr';
var elementsWeights = [8,4,2,1]; // keep original weighting
var userDecision = "";
var positiveOrder = [];
var negativeOrder = [];
var positiveImpacts = [];
var negativeImpacts = [];
var validationCount = 0;

var questionsDiv, resultsDiv, resultContentDiv;

function t(key){
  var dict = I18N[LANG];
  var v = dict[key];
  if (typeof v === 'function') {
    var args = Array.prototype.slice.call(arguments, 1);
    return v.apply(null, args);
  }
  return v;
}

function setLang(lang){
  LANG = lang;
  document.documentElement.lang = lang;
  var fr = document.getElementById('btn-fr');
  var en = document.getElementById('btn-en');
  if(fr) fr.className = (lang==='fr'?'active':''); else if(fr!==null){}
  if(en) en.className = (lang==='en'?'active':''); else if(en!==null){}
  var dict = I18N[lang];
  document.title = dict.title;
  var i18n = document.querySelectorAll('[data-i18n]');
  for (var i=0;i<i18n.length;i++){
    var el = i18n[i];
    var key = el.getAttribute('data-i18n');
    if (dict[key]) el.innerHTML = dict[key];
  }
  var ph = document.querySelectorAll('[data-i18n-placeholder]');
  for (var j=0;j<ph.length;j++){
    var elp = ph[j];
    var k = elp.getAttribute('data-i18n-placeholder');
    if (dict[k]) elp.setAttribute('placeholder', dict[k]);
  }
  var defBox = document.getElementById('definition-box');
  if(defBox && defBox.style.display==='block'){ updateDefinitionFromText(defBox.innerHTML); }
}

// === Core (conserve les m√™mes handlers inline) ===
function askImpact(kind, order, callback){
  questionsDiv.innerHTML = '';
  var index = 0;
  var impacts = [];
  function next(){
    if(index >= order.length){ callback(impacts); return; }
    var el = order[index];
    var html = ""
      + "<h2 style='color:#4aa3ff;'>" + t('dacTitle') + " : " + userDecision + "</h2>"
      + "<h3 class='" + (kind==='Positive'?'positive-question':'negative-question') + "'>"
      + (kind==='Positive' ? t('ifDo') : t('ifDont')) + "</h3>"
      + "<p class='" + (kind==='Positive'?'positive-question':'negative-question') + "'>"
      + t('isImpactOn', el, kind) + "</p>"
      + "<button class='button yes-button' onclick=\"recordImpact('y')\">" + t('yes') + "</button>"
      + "<button class='button no-button'  onclick=\"recordImpact('n')\">" + t('no') + "</button>";
    questionsDiv.innerHTML = html;
    updateDefinitionFromText(html);
  }
  window.recordImpact = function(resp){
    impacts.push(resp==='y');
    index++;
    next();
  };
  next();
}

function validateOrder(order, kind, callback){
  var html = ""
    + "<h2 style='color:#4aa3ff;'>" + t('dacTitle') + " : " + userDecision + "</h2>"
    + "<h3 class='" + (kind==='Positive'?'positive-question':'negative-question') + "'>"
    + (kind==='Positive' ? t('ifDo') : t('ifDont')) + "</h3>"
    + "<p class='" + (kind==='Positive'?'positive-question':'negative-question') + "'>"
    + t('orderIs', kind, order) + "</p>"
    + "<p class='" + (kind==='Positive'?'positive-question':'negative-question') + "'>"
    + t('orderCorrect') + "</p>"
    + "<button class='button yes-button' onclick='validationResponse(true)'>" + t('yes') + "</button>"
    + "<button class='button no-button' onclick='validationResponse(false)'>" + t('no') + "</button>";
  questionsDiv.innerHTML = html;
  updateDefinitionFromText(html);
  window.validationResponse = function(valid){
    if(!valid) validationCount++;
    callback(valid);
  };
}

function sortElements(els, kind, callback){
  var order = [els[0]];
  var index = 1;
  function next(){
    if(index >= els.length){
      validateOrder(order, kind, function(valid){
        if(valid){ callback(order); }
        else { sortElements(els, kind, callback); }
      });
      return;
    }
    var current = els[index];
    var position = 0;
    function compare(){
      if(position >= order.length){
        order.push(current);
        index++;
        next();
        return;
      }
      var reference = order[position];
      var question = (LANG==='fr')
        ? "L'impact de <span class='emphasis'>" + current + "</span> est-il plus important que celui de <span class='emphasis'>" + reference + "</span> ?"
        : "Is the impact of <span class='emphasis'>" + current + "</span> greater than <span class='emphasis'>" + reference + "</span>?";
      var html = ""
        + "<h2 style='color:#4aa3ff;'>" + t('dacTitle') + " : " + userDecision + "</h2>"
        + "<h3 class='" + (kind==='Positive'?'positive-question':'negative-question') + "'>"
        + (kind==='Positive' ? t('ifDo') : t('ifDont')) + "</h3>"
        + "<p class='" + (kind==='Positive'?'positive-question':'negative-question') + "'>" + question + "</p>"
        + "<button class='button yes-button' onclick='compareResponse(true)'>" + t('yes') + "</button>"
        + "<button class='button no-button'  onclick='compareResponse(false)'>" + t('no') + "</button>";
      questionsDiv.innerHTML = html;
      updateDefinitionFromText(html);
    }
    window.compareResponse = function(higher){
      if(higher){ order.splice(position, 0, current); index++; next(); }
      else { position++; compare(); }
    };
    compare();
  }
  next();
}

function calculateResults(){
  var total = 15;
  var detailedPositive = [];
  var detailedNegative = [];
  var totalPositive = 0, totalNegative = 0;

  for (var i=0;i<positiveOrder.length;i++){
    if(positiveImpacts[i]){
      var v = elementsWeights[i];
      totalPositive += v;
      detailedPositive.push({element: positiveOrder[i], percentage: Math.round((v/total)*100)});
    }
  }
  for (var j=0;j<negativeOrder.length;j++){
    if(negativeImpacts[j]){
      var v2 = elementsWeights[j];
      totalNegative += v2;
      detailedNegative.push({element: negativeOrder[j], percentage: Math.round((v2/total)*100)});
    }
  }
  detailedPositive.sort(function(a,b){return b.percentage - a.percentage;});
  detailedNegative.sort(function(a,b){return b.percentage - a.percentage;});

  var percentPositive = Math.round((totalPositive/total)*100);
  var percentNegative = Math.round((totalNegative/total)*100);
  var scorePositive = Math.round((totalPositive/total)*10);
  var scoreNegative = Math.round((totalNegative/total)*10);
  var globalScore = Math.round((scorePositive + scoreNegative) / 2);

  var posDetails = detailedPositive.length
    ? "<div class='precision'>"+t('details')+"</div><ul>" + detailedPositive.map(function(it){return "<li>"+it.element+" : "+it.percentage+"%</li>";}).join("") + "</ul>"
    : "<p>"+t('none')+"</p>";
  var negDetails = detailedNegative.length
    ? "<div class='precision'>"+t('details')+"</div><ul>" + detailedNegative.map(function(it){return "<li>"+it.element+" : "+it.percentage+"%</li>";}).join("") + "</ul>"
    : "<p>"+t('none')+"</p>";

  resultContentDiv.innerHTML = ""
    + "<div class='result-header'>"+t('dacTitle')+" :</div>"
    + "<p style='font-weight:bold; font-size:18px; color:#e6e6e6;'>"+userDecision+"</p>"
    + "<div class='empty-space'></div>"
    + "<div class='result-header'>"+t('overallResult')+"</div>"
    + "<p class='precision'>"+t('overallResultDesc')+"</p>"
    + "<p>"+t('globalScore', globalScore)+"</p>"
    + "<div class='empty-space'></div>"
    + "<div class='result-header'>"+t('posTable')+"</div>"
    + "<p class='precision'>"+t('posDesc')+"</p>"
    + "<p>"+t('posScore', scorePositive, percentPositive)+"</p>"
    + posDetails
    + "<div class='empty-space'></div>"
    + "<div class='result-header'>"+t('negTable')+"</div>"
    + "<p class='precision'>"+t('negDesc')+"</p>"
    + "<p>"+t('negScore', scoreNegative, percentNegative)+"</p>"
    + negDetails
    + "<div class='empty-space'></div>"
    + "<p class='emphasis'>"+t('caution')+"</p>"
    + "<div class='empty-space'></div>"
    + "<div class='result-header'>"+t('rejTitle')+"</div>"
    + "<p>"+t('rejDesc')+"</p>"
    + "<p>"+(LANG==='fr'?'Nombre':'Count')+": "+validationCount+"</p>"
    + "<div class='result-header'>"+t('posChart')+"</div>"
    + "<p class='precision'>"+t('posChartDesc')+"</p>"
    + "<canvas id='positiveChart' width='400' height='300'></canvas>"
    + "<div class='empty-space'></div>"
    + "<div class='result-header'>"+t('negChart')+"</div>"
    + "<p class='precision'>"+t('negChartDesc')+"</p>"
    + "<canvas id='negativeChart' width='400' height='300'></canvas>"
    + "<div class='empty-space'></div>";

  document.getElementById('questions').innerHTML = '';
  var defBox = document.getElementById('definition-box');
  if (defBox){ defBox.innerHTML = ''; defBox.style.display = 'none'; }
  resultsDiv.classList.remove('hidden');

  var ctxPos = document.getElementById('positiveChart').getContext('2d');
  var ctxNeg = document.getElementById('negativeChart').getContext('2d');

  var posLabels = positiveOrder.map(function(el,i){ return !positiveImpacts[i] ? el.charAt(0) : null; }).filter(function(x){return x!==null;});
  var posData   = positiveOrder.map(function(el,i){ return !positiveImpacts[i] ? Math.round((elementsWeights[i]/15)*100) : null; }).filter(function(x){return x!==null;});
  var negLabels = negativeOrder.map(function(el,i){ return !negativeImpacts[i] ? el.charAt(0) : null; }).filter(function(x){return x!==null;});
  var negData   = negativeOrder.map(function(el,i){ return !negativeImpacts[i] ? Math.round((elementsWeights[i]/15)*100) : null; }).filter(function(x){return x!==null;});

  Chart.register(window['chartjs-plugin-annotation']);
  new Chart(ctxPos, {
    type:'bar',
    data:{ labels:posLabels, datasets:[{ label:(LANG==='fr'?'% Impact positif':'% Positive impact'), data:posData, backgroundColor:'#23d14d' }]},
    options:{ plugins:{ annotation:{ annotations:{ faible:{type:'box',yMin:0,yMax:7,backgroundColor:'rgba(255,0,0,.1)'},
                                            normal:{type:'box',yMin:7,yMax:13,backgroundColor:'rgba(255,165,0,.1)'},
                                            important:{type:'box',yMin:13,yMax:27,backgroundColor:'rgba(255,255,0,.1)'},
                                            tresImportant:{type:'box',yMin:27,yMax:53,backgroundColor:'rgba(0,128,0,.1)'} } } },
              indexAxis:'x', scales:{ y:{beginAtZero:true,max:53}, x:{ticks:{font:{size:14}}} } }
  });

  Chart.register(window['chartjs-plugin-annotation']);
  new Chart(ctxNeg, {
    type:'bar',
    data:{ labels:negLabels, datasets:[{ label:(LANG==='fr'?'% Impact n√©gatif':'% Negative impact'), data:negData, backgroundColor:'#ff3434' }]},
    options:{ plugins:{ annotation:{ annotations:{ faible:{type:'box',yMin:0,yMax:7,backgroundColor:'rgba(255,0,0,.1)'},
                                            normal:{type:'box',yMin:7,yMax:13,backgroundColor:'rgba(255,165,0,.1)'},
                                            important:{type:'box',yMin:13,yMax:27,backgroundColor:'rgba(255,255,0,.1)'},
                                            tresImportant:{type:'box',yMin:27,yMax:53,backgroundColor:'rgba(0,128,0,.1)'} } } },
              indexAxis:'x', scales:{ y:{beginAtZero:true,max:53}, x:{ticks:{font:{size:14}}} } }
  });
}

function restart(){ window.location.href = 'https://frankproulx.com'; }

function start(){
  var els = I18N[LANG].elements.slice(0);
  sortElements(els, 'Positive', function(order){
    positiveOrder = order;
    askImpact('Positive', positiveOrder, function(imp){
      positiveImpacts = imp;
      sortElements(els, 'Negative', function(orderN){
        negativeOrder = orderN;
        askImpact('Negative', negativeOrder, function(impN){
          negativeImpacts = impN;
          calculateResults();
        });
      });
    });
  });
}

function launchCalculator(){
  var input = document.getElementById("userDecision").value;
  input = input ? input.trim() : "";
  userDecision = input || (LANG==='fr' ? "(non pr√©cis√©)" : "(unspecified)");
  document.getElementById("welcome-screen").style.display = "none";
  document.getElementById("main-content").classList.remove("hidden");
  questionsDiv = document.getElementById('questions');
  resultsDiv   = document.getElementById('results');
  resultContentDiv = document.getElementById('result-content');
  start();
}

// ===== Bo√Æte de d√©finitions contextuelles =====
function updateDefinitionFromText(text){
  var resultsVisible = !document.getElementById("results").classList.contains("hidden");
  var box = document.getElementById("definition-box");
  if (resultsVisible){
    if (box){ box.innerHTML = ""; box.style.display = "none"; }
    return;
  }
  var defs = I18N[LANG].defs;
  var out = [];
  for (var key in defs){
    if (text.indexOf(key) !== -1){ out.push(defs[key]); }
  }
  if (out.length){
    box.innerHTML = out.join("<br><br>");
    box.style.display = "block";
  } else {
    box.innerHTML = "";
    box.style.display = "none";
  }
}

// Init langue par d√©faut
setLang('fr');
</script>
</body>
</html>
